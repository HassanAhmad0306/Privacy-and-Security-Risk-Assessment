<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Privacy & Security Risk Assessment</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Font Awesome Icons -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <!-- CryptoJS for hashing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
      body {
        background: linear-gradient(
          135deg,
          rgb(30, 60, 114) 0%,
          rgb(42, 82, 152) 100%
        );
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }
      .container {
        max-width: 450px;
        width: 100%;
      }
      .form {
        background-color: rgba(255, 255, 255, 0.9);
        padding: 2rem;
        border-radius: 1rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      }
      h1 {
        text-align: center;
        margin-bottom: 2rem;
        color: #333;
        font-weight: 700;
      }
      .password-field {
        position: relative;
      }
      .password-input {
        width: 100%;
        padding: 12px 45px;
        margin-bottom: 1.5rem;
        border: 1px solid #ced4da;
        border-radius: 10px;
        font-size: 16px;
        height: 50px;
        outline: none;
        transition: border-color 0.3s;
        background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="%236c757d" class="bi bi-lock-fill" viewBox="0 0 16 16"><path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2m3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2"/></svg>');
        background-repeat: no-repeat;
        background-position: 15px center;
        background-size: 16px;
      }
      .password-input:focus {
        border-color: #2575fc;
        box-shadow: 0 0 0 0.25rem rgba(37, 117, 252, 0.25);
      }
      .eye-icon {
        position: absolute;
        right: 16px;
        top: 35%;
        transform: translateY(-50%);
        cursor: pointer;
        color: #6c757d;
        font-size: 18px;
      }
      button {
        width: 100%;
        background-color: #2575fc;
        color: white;
        border: none;
        padding: 12px;
        font-size: 18px;
        font-weight: 600;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        height: 50px;
      }
      button:hover {
        background-color: #1a65e0;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }
      .back-button {
        background-color: #6c757d;
        margin-top: 15px;
      }
      .back-button:hover {
        background-color: #5a6268;
      }
      .error-message {
        color: #dc3545;
        font-size: 14px;
        margin-top: 10px;
        text-align: center;
        min-height: 20px;
      }
      .success-message {
        color: #198754;
        font-size: 14px;
        margin-top: 10px;
        text-align: center;
      }
      .strength-meter {
        height: 8px;
        width: 100%;
        background-color: #f1f1f1;
        border-radius: 4px;
        margin-bottom: 1rem;
        overflow: hidden;
      }
      .strength-meter-fill {
        height: 100%;
        width: 0%;
        transition: width 0.3s, background-color 0.3s;
      }
      .weak {
        background-color: #dc3545;
        width: 33%;
      }
      .medium {
        background-color: #ffc107;
        width: 66%;
      }
      .strong {
        background-color: #198754;
        width: 100%;
      }
      .password-requirements {
        font-size: 12px;
        margin-bottom: 1rem;
      }
      .requirement {
        display: flex;
        align-items: center;
        margin-bottom: 3px;
        color: red;
      }
      .requirement i {
        margin-right: 5px;
        font-size: 10px;
        color: red;
      }
      .requirement.met {
        color: #198754;
      }
      .requirement.met i {
        color: #198754;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Change Password Form -->
      <div id="change-password-form" class="form">
        <h1>Change Password</h1>
        <form id="passwordChangeForm">
          <div class="password-field">
            <input
              type="password"
              id="current-password"
              class="password-input"
              placeholder="Current Password"
              autocomplete="current-password"
              required
            />
            <i id="show-current-password" class="fas fa-eye eye-icon"></i>
          </div>

          <div class="password-field">
            <input
              type="password"
              id="new-password"
              class="password-input"
              placeholder="New Password"
              autocomplete="new-password"
              required
            />
            <i id="show-new-password" class="fas fa-eye eye-icon"></i>
          </div>

          <div class="strength-meter">
            <div id="strength-meter-fill" class="strength-meter-fill"></div>
          </div>

          <div class="password-requirements">
            <div class="requirement" id="length-req">
              <i class="fas fa-circle"></i> At least 8 characters
            </div>
            <div class="requirement" id="uppercase-req">
              <i class="fas fa-circle"></i> At least 1 uppercase letter
            </div>
            <div class="requirement" id="lowercase-req">
              <i class="fas fa-circle"></i> At least 1 lowercase letter
            </div>
            <div class="requirement" id="number-req">
              <i class="fas fa-circle"></i> At least 1 number
            </div>
          </div>

          <div class="password-field">
            <input
              type="password"
              id="confirm-password"
              class="password-input"
              placeholder="Confirm New Password"
              autocomplete="new-password"
              required
            />
            <i id="show-confirm-password" class="fas fa-eye eye-icon"></i>
          </div>

          <button type="submit">Change Password</button>
          <button type="button" id="back-button" class="back-button">
            Back
          </button>
        </form>
        <div id="message" class="error-message"></div>
      </div>
    </div>

    <!-- Script for password change functionality -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Check if user is logged in
        const currentUser = sessionStorage.getItem("currentUser");
        // Commented out for testing - uncomment in production
        /*if (!currentUser) {
          window.location.href = "login.html";
          return;
        }*/

        // Hash function using SHA-256
        function hashPassword(password) {
          return CryptoJS.SHA256(password).toString(CryptoJS.enc.Hex);
        }

        // Decrypt AES key
        function decryptAESKey(encryptedAESKey, password) {
          try {
            const bytes = CryptoJS.AES.decrypt(encryptedAESKey, password);
            return bytes.toString(CryptoJS.enc.Utf8);
          } catch (error) {
            return null;
          }
        }

        // Encrypt AES key
        function encryptAESKey(aesKey, password) {
          return CryptoJS.AES.encrypt(aesKey, password).toString();
        }

        // Toggle password visibility functions
        document
          .getElementById("show-current-password")
          .addEventListener("click", function () {
            togglePasswordVisibility("current-password", this);
          });

        document
          .getElementById("show-new-password")
          .addEventListener("click", function () {
            togglePasswordVisibility("new-password", this);
          });

        document
          .getElementById("show-confirm-password")
          .addEventListener("click", function () {
            togglePasswordVisibility("confirm-password", this);
          });

        function togglePasswordVisibility(inputId, iconElement) {
          const passwordInput = document.getElementById(inputId);
          const currentType = passwordInput.getAttribute("type");

          if (currentType === "password") {
            passwordInput.setAttribute("type", "text");
            iconElement.classList.remove("fa-eye");
            iconElement.classList.add("fa-eye-slash");
          } else {
            passwordInput.setAttribute("type", "password");
            iconElement.classList.remove("fa-eye-slash");
            iconElement.classList.add("fa-eye");
          }
        }

        // Password strength meter
        const newPasswordInput = document.getElementById("new-password");
        const strengthMeterFill = document.getElementById(
          "strength-meter-fill"
        );

        // Password requirements
        const lengthReq = document.getElementById("length-req");
        const uppercaseReq = document.getElementById("uppercase-req");
        const lowercaseReq = document.getElementById("lowercase-req");
        const numberReq = document.getElementById("number-req");

        newPasswordInput.addEventListener("input", function () {
          const password = this.value;
          updatePasswordStrength(password);
          checkPasswordRequirements(password);
        });

        function updatePasswordStrength(password) {
          let strength = 0;

          if (password.length >= 8) {
            strength += 1;
          }

          if (/[A-Z]/.test(password)) {
            strength += 1;
          }

          if (/[a-z]/.test(password)) {
            strength += 1;
          }

          if (/[0-9]/.test(password)) {
            strength += 1;
          }

          strengthMeterFill.className = "strength-meter-fill";
          if (strength === 0) {
            strengthMeterFill.style.width = "0%";
          } else if (strength <= 2) {
            strengthMeterFill.classList.add("weak");
          } else if (strength === 3) {
            strengthMeterFill.classList.add("medium");
          } else {
            strengthMeterFill.classList.add("strong");
          }
        }

        function checkPasswordRequirements(password) {
          if (password.length >= 8) {
            updateRequirement(lengthReq, true);
          } else {
            updateRequirement(lengthReq, false);
          }

          if (/[A-Z]/.test(password)) {
            updateRequirement(uppercaseReq, true);
          } else {
            updateRequirement(uppercaseReq, false);
          }

          if (/[a-z]/.test(password)) {
            updateRequirement(lowercaseReq, true);
          } else {
            updateRequirement(lowercaseReq, false);
          }

          if (/[0-9]/.test(password)) {
            updateRequirement(numberReq, true);
          } else {
            updateRequirement(numberReq, false);
          }
        }

        function updateRequirement(element, isMet) {
          if (isMet) {
            element.classList.remove("unmet");
            element.classList.add("met");
          } else {
            element.classList.remove("met");
            element.classList.add("unmet");
          }
        }

        // Back button functionality
        document
          .getElementById("back-button")
          .addEventListener("click", function () {
            window.location.href = "Dashboard.html";
          });

        // Password change form submission
        document
          .getElementById("passwordChangeForm")
          .addEventListener("submit", function (e) {
            e.preventDefault();

            const currentPassword =
              document.getElementById("current-password").value;
            const newPassword = document.getElementById("new-password").value;
            const confirmPassword =
              document.getElementById("confirm-password").value;
            const messageElement = document.getElementById("message");

            // Validate inputs
            if (!currentPassword || !newPassword || !confirmPassword) {
              messageElement.textContent = "All fields are required";
              messageElement.className = "error-message";
              return;
            }

            if (newPassword !== confirmPassword) {
              messageElement.textContent = "New passwords do not match";
              messageElement.className = "error-message";
              return;
            }

            // Password strength check
            const hasMinLength = newPassword.length >= 8;
            const hasUppercase = /[A-Z]/.test(newPassword);
            const hasLowercase = /[a-z]/.test(newPassword);
            const hasNumber = /[0-9]/.test(newPassword);

            if (!(hasMinLength && hasUppercase && hasLowercase && hasNumber)) {
              messageElement.textContent =
                "New password does not meet requirements";
              messageElement.className = "error-message";
              return;
            }

            try {
              // For testing when not logged in
              const effectiveUser = currentUser || "test";
              // Get users from localStorage
              const users = JSON.parse(localStorage.getItem("users")) || [];

              // Find current user
              const userIndex = users.findIndex(
                (u) => u.username === effectiveUser
              );

              if (userIndex === -1) {
                messageElement.textContent = "User not found";
                messageElement.className = "error-message";
                return;
              }

              // Verify current password
              const hashedCurrentPassword = hashPassword(currentPassword);
              if (users[userIndex].password !== hashedCurrentPassword) {
                messageElement.textContent = "Current password is incorrect";
                messageElement.className = "error-message";
                return;
              }

              // Same password check
              if (currentPassword === newPassword) {
                messageElement.textContent =
                  "New password must be different from current password";
                messageElement.className = "error-message";
                return;
              }
              // Decrypt AES key with current password
              const aesKey = decryptAESKey(
                users[userIndex].encryptedAESKey,
                currentPassword
              );
              if (!aesKey) {
                messageElement.textContent =
                  "Failed to decrypt AES key with current password";
                messageElement.className = "error-message";
                return;
              }
              // Re-encrypt AES key with new password
              const newEncryptedAESKey = encryptAESKey(aesKey, newPassword);
              // Hash and update the new password and encrypted AES key
              const hashedNewPassword = hashPassword(newPassword);
              users[userIndex].password = hashedNewPassword;
              users[userIndex].encryptedAESKey = newEncryptedAESKey;
              // Save updated users to localStorage
              localStorage.setItem("users", JSON.stringify(users));
              // Update sessionStorage with new AES key
              sessionStorage.setItem("userAESKey", aesKey);
              // Show success message
              messageElement.textContent = "Password changed successfully!";
              messageElement.className = "success-message";
              // Clear form
              document.getElementById("current-password").value = "";
              document.getElementById("new-password").value = "";
              document.getElementById("confirm-password").value = "";
              // Reset strength meter
              strengthMeterFill.className = "strength-meter-fill";
              strengthMeterFill.style.width = "0%";

              // Reset requirements
              updateRequirement(lengthReq, false);
              updateRequirement(uppercaseReq, false);
              updateRequirement(lowercaseReq, false);
              updateRequirement(numberReq, false);

              // Redirect after a delay
              setTimeout(function () {
                window.location.href = "Dashboard.html";
              }, 2000);
            } catch (error) {
              console.error("Password change error:", error);
              messageElement.textContent =
                "An error occurred. Please try again.";
              messageElement.className = "error-message";
            }
          });

        // Check if localStorage is available
        function isLocalStorageAvailable() {
          try {
            const test = "__test__";
            localStorage.setItem(test, test);
            localStorage.removeItem(test);
            return true;
          } catch (e) {
            return false;
          }
        }

        // Show warning if localStorage is not available
        if (!isLocalStorageAvailable()) {
          const messageElement = document.getElementById("message");
          messageElement.textContent =
            "Local storage is not available. Password change functionality will not work.";
          messageElement.className = "error-message";
        }
      });
    </script>
  </body>
</html>
